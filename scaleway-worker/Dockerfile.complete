FROM node:20-alpine

# Install git, bash, and other essentials
RUN apk add --no-cache git bash curl

# Install bun for running TypeScript
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

# Create directories
WORKDIR /fondation
RUN mkdir -p /scaleway/worker /tmp/repos /tmp/outputs

# Copy all necessary Fondation files from local build context
COPY --from=fondation-source dist/cli.bundled.cjs ./cloud-run/
COPY --from=fondation-source prompts ./cloud-run/prompts
COPY --from=fondation-source prompts ./prompts
COPY --from=fondation-source package.json .

# Copy worker files
WORKDIR /scaleway/worker
COPY server.js .
COPY worker.js .

# Install Express
WORKDIR /scaleway
COPY package.json .
RUN npm install express

# Install Claude CLI globally for authentication
RUN npm install -g @anthropic-ai/claude-code

# Create scaleway user and set permissions
RUN adduser -D -s /bin/bash scaleway && \
    chown -R scaleway:scaleway /scaleway && \
    chown -R scaleway:scaleway /fondation && \
    chown -R scaleway:scaleway /tmp/repos && \
    chown -R scaleway:scaleway /tmp/outputs

USER scaleway
WORKDIR /scaleway

EXPOSE 8080
ENTRYPOINT ["node", "/scaleway/worker/server.js"]